<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Project</title>
  <link rel="stylesheet" href="../../../vendor/metro-dist/css/metro.min.css">
  <link rel="stylesheet" href="../../../vendor/metro-dist/css/metro-icons.css">
  <link rel="stylesheet" href="../../../vendor/metro-dist/css/metro-colors.css">
  <link rel="stylesheet" href="../../../css/style.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="tile-container bg-darkCobalt">

    <div class="tile tile-large bg-red fg-white" data-role="tile" onclick="metroDialog.open('#dialog-project-details')">
      <div class="tile-content iconic">
          <span class="icon mif-cogs"></span>
          <span class="tile-label">Project Details</span>
      </div>
      <div class="padding20" data-overlay="true" data-overlay-click-close="true" data-overlay-color="op-dark" data-role="dialog" id="dialog-project-details" data-close-button="true">
        <form id="form-project-details" action="#">
          <h2>Project Details</h2>

          <div class="input-control text full-size" data-role="input">
            <label for="project_name">Project Name *:</label>
            <input type="text" id="project_name" name="project_name" data-validate-func="required" data-validate-hint="This field can not be empty!" data-validate-hint-position="top">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>

          <div class="input-control text full-size" data-role="input">
            <label for="project_path" class="control-label">Project path *:</label>
            <input type="text" id="project_path" name="project_path" disabled="disabled">
          </div>
          
          <div class="input-control select multiple full-size">
            <label for="type">Type:</label>
            <select id="type" name="type" multiple="multiple">
              <option value="">Blank</option>
              <option value="cordova">Cordova</option>
              <option value="ionic">Ionic</option>
              <option value="react">React</option>
            </select>
          </div>

          <div class="input-control text full-size" data-role="input">
            <label for="author">Author:</label>
            <input type="text" id="author" name="author">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>

          <div class="input-control text full-size" data-role="input">
            <label for="author_uri">Author URI:</label>
            <input type="text" id="author_uri" name="author_uri">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>

          <div class="input-control textarea full-size" data-role="input">
            <label for="description">Description:</label>
            <textarea id="description" name="description"></textarea>
          </div>

          <div class="input-control text full-size" data-role="input">
            <label for="version">Version:</label>
            <input type="text" id="version" name="version">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>

          <div class="input-control text full-size" data-role="input">
            <label for="license">License:</label>
            <input type="text" id="license" name="license">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>

          <div class="input-control text full-size" data-role="input">
            <label for="license_uri">License URI:</label>
            <input type="text" id="license_uri" name="license_uri">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>
          
          <div class="input-control text full-size" data-role="input">
            <label for="tags">Tags:</label>
            <input type="text" id="tags" name="tags">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>
          <div class="floating-action"> 
            <button class="button primary rounded" type="submit"><span class="mif-floppy-disk"></span> save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="tile tile-large bg-yellow fg-black" data-role="tile" onclick="metroDialog.open('#dialog-project-settings')">
      <div class="tile-content iconic">
          <span class="icon mif-cogs"></span>
          <span class="tile-label">Project Settings</span>
      </div>
      <div class="padding20" data-overlay="true" data-overlay-click-close="true" data-overlay-color="op-dark" data-role="dialog" id="dialog-project-settings" data-close-button="true">
        <form id="form-project-settings" action="#">
          <h2>Project Settings</h2>

          <div class="input-control text full-size" data-role="input">
            <label for="node_js_custom_path">Node.js Custom Path:</label>
            <input type="text" id="node_js_custom_path" name="node_js_custom_path">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>
          
          <div class="input-control text full-size" data-role="input">
            <label for="npm_custom_path">Npm Custom Path:</label>
            <input type="text" id="npm_custom_path" name="npm_custom_path">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>
          
          <h3>Build Flow</h3>

          <div class="input-control text full-size" data-role="input">
            <label for="build_flow_source_folder">Source Folder:</label>
            <input type="text" id="build_flow_source_folder" name="build_flow_source_folder">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>

          <div class="input-control text full-size" data-role="input">
            <label for="build_flow_destination_folder">Destination Folder:</label>
            <input type="text" id="build_flow_destination_folder" name="build_flow_destination_folder">
            <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
          </div>

          <div class="input-control select multiple full-size">
            <label for="build_flow_options">Options:</label>
            <select class="build_flow_options" multiple="multiple" data-field-type="select">
              <option value="">None</option>
              <option value="--all">--all</option>
              <option value="--pretty">--pretty</option>
              <option value="--sourcemaps">--sourcemaps</option>
            </select>
            <small>Select options that apply to every time</small>
          </div>
          

          <div class="input-control text full-size" data-role="input">
            <label for="build_flow-ignore">--ignore:</label>
            <input class=" build_flow-ignore build_flow_options" type="text" name="ignore" value="" data-field-type="option">
            <button class="button helper-button clear" type="button" tabindex="-1"><span class="mif-cross"></span></button>
            <small></small>
          </div>

          <div class="input-control text full-size" data-role="input">
            <label for="build_flow-sourcemaps">--sourcemaps:</label>
            <input class=" build_flow-sourcemaps build_flow_options" type="text" name="sourcemaps" value="" data-field-type="option">
            <button class="button helper-button clear" type="button" tabindex="-1"><span class="mif-cross"></span></button>
            <small></small>
          </div>

          <div class="input-control text full-size" data-role="input">
            <label for="build_flow-extensions">--extensions:</label>
            <input class=" build_flow-extensions build_flow_options" type="text" name="extensions" value="" data-field-type="option">
            <button class="button helper-button clear" type="button" tabindex="-1"><span class="mif-cross"></span></button>
            <small></small>
          </div>

          <div class="floating-action"> 
            <button class="button primary rounded" type="submit"><span class="mif-floppy-disk"></span> save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="tile tile-large bg-black fg-white" data-role="tile" onclick="metroDialog.open('#dialog-flow-settings')">
      <div class="tile-content iconic">
        <span class="icon"><img src="img/flow-logo.png" alt=""></span>
        <span class="tile-label">Flow Settings</span>
      </div>
      <div class="padding20" data-overlay="true" data-overlay-click-close="true" data-overlay-color="op-dark" data-role="dialog" id="dialog-flow-settings" data-close-button="true">
        <form id="form-flow-settings" action="#">
          <h2>Flow Settings</h2>
          <div class="accordion" data-role="accordion">
            <div class="frame">
              <div class="heading">Include</div>
              <div id="include-flow" class="content">
                <div class="container-settings-flow-inputs"></div>
                <button data-id-flow="include-flow" class="flow-add-button button primary place-right" type="button">Add</button>
                <button data-id-flow="include-flow" class="flow-remove-button button danger no-float" type="button">Remove</button>
              </div>
            </div>
            <div class="frame">
              <div class="heading">Ignore</div>
              <div id="ignore-flow" class="content">
                <div class="container-settings-flow-inputs"></div>
                <button data-id-flow="ignore-flow" class="flow-add-button button primary place-right" type="button">Add</button>
                <button data-id-flow="ignore-flow" class="flow-remove-button button danger no-float" type="button">Remove</button>
              </div>
            </div>
            <div class="frame">
              <div class="heading">Libs</div>
              <div id="libs-flow" class="content">
                <div class="container-settings-flow-inputs"></div>
                <button data-id-flow="libs-flow" class="flow-add-button button primary place-right" type="button">Add</button>
                <button data-id-flow="libs-flow" class="flow-remove-button button danger no-float" type="button">Remove</button>
              </div>
            </div>
            <div class="frame">
              <div class="heading">Options</div>
              <div id="options-flow" class="content">
                <div class="container-settings-flow-inputs"></div>
                <button data-id-flow="options-flow" class="flow-add-button button primary place-right" type="button">Add</button>
                <button data-id-flow="options-flow" class="flow-remove-button button danger no-float" type="button">Remove</button>
              </div>
            </div>
            <div class="frame active">
              <div class="heading">Global Settings</div>
              <div id="global-flow" class="content">
                <div class="container-settings-flow-inputs">
                  <div class="container-flow-input">
                    <label class="switch">
                      <input type="checkbox" id="flow_checker_enabled">
                      <span class="check"></span>
                      <span class="text-switch">Flow Checker Enabled</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="floating-action"> 
            <button class="button primary rounded" type="submit"><span class="mif-floppy-disk"></span> save</button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <script>
    window.$ = window.jQuery = require('../../../vendor/jquery/jquery-1.12.2.min.js')
    require('../../../vendor/metro-dist/js/metro.min.js')
    const fs = require("fs")
    const utilWeb = require('../../../js/utilWeb.js')

    const {ipcRenderer} = require('electron')
    const {dialog} = require('electron').remote

    let project_type = []

    function type_change () {
      let types = ( $("#type").val() ) ? $("#type").val().filter(function(item){ return (item !== "") ? true : false }) : []

      $("#type option").prop("disabled", false)
      for(let i = 0; i < types.length; i++){
        let type = types[i]
        if (fs.existsSync(__dirname+"/../../default_settings/"+type+"/default_config.js") ){
          let default_config = require(__dirname+"/../../default_settings/"+type+"/default_config.js")
          let dependencies = default_config.dependencies
          if (dependencies) {
            for(let i = 0, length1 = dependencies.length; i < length1; i++){
              let dipendency = dependencies[i]
              if (types.indexOf(dipendency) < 0) {
                types.push(dipendency)
              }
              $("#type option[value='"+dipendency+"']").prop("disabled", true)
              $("#type option[value='"+dipendency+"']").prop("selected", false)
            }
          }
        }
      }
    }
      
    $(document).ready(() => {
      
      $("#form-project-details").on("submit", function(event) {
        event.preventDefault()
        let project_details = {
          "project_name": $("#project_name").val().trim(),
          "author": $("#author").val().trim(),
          "author_uri": $("#author_uri").val().trim(),
          "description": $("#description").val().trim(),
          "version": $("#version").val().trim(),
          "license": $("#license").val().trim(),
          "license_uri": $("#license_uri").val().trim(),
          "tags": $("#tags").val().trim(),
          "type": ( $("#type").val() ) ? $("#type").val().filter(function(item){ return (item !== "") ? true : false }) : []
        }
        ipcRenderer.send('form-project-details', project_details)
      })

      $("#form-project-settings").on("submit", function(event) {
        event.preventDefault()
        let project_settings = {
          "node_js_custom_path": $("#node_js_custom_path").val().trim(),
          "npm_custom_path": $("#npm_custom_path").val().trim(),
          "build_flow": {
            "source_folder": $("#build_flow_source_folder").val().trim(),
            "destination_folder": $("#build_flow_destination_folder").val().trim(),
            "options": utilWeb.get_options(".build_flow_options")
          }
        }
        ipcRenderer.send('form-project-settings', project_settings)
      })

      $("#type").change(type_change)

      $("#form-flow-settings").on("submit", function(event) {
        event.preventDefault()
        let includes = Array.prototype.map.call(document.querySelectorAll(".include-flow-input"), function (item) {
          return $(item).val().trim()
        })
        let ignores = Array.prototype.map.call(document.querySelectorAll(".ignore-flow-input"), function (item) {
          return $(item).val().trim()
        })
        let libs = Array.prototype.map.call(document.querySelectorAll(".libs-flow-input"), function (item) {
          return $(item).val().trim()
        })
        let options = Array.prototype.map.call(document.querySelectorAll(".options-flow-input"), function (item, index) {
          return [$($(item).parents(".row").find(".options-flow-select")[index]).val().trim(), $(item).val().trim()]
        })
        let flow_settings = {
          "ignore": ignores,
          "include": includes,
          "libs": libs,
          "options": options,
          "flow_checker_enabled": ($('#flow_checker_enabled:checked').length > 0) ? true : false
        }
        ipcRenderer.send('form-flow-settings', flow_settings)

      })

      $(".flow-add-button").click(function (event) {
        let id = $(this).attr("data-id-flow")
        if ( id != "options-flow" ) { 
          $("#"+id+" .container-settings-flow-inputs").append(`
            <div class="container-flow-input">
              <div class="input-control text full-size" data-role="input">
                <label class="input-control checkbox small-check">
                  <input type="checkbox">
                  <span class="check"></span>
                  <span class="caption">Select to delete</span>
                </label>
                <input type="text" class="${id}-input" value="">
                <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
              </div>
            </div>
          `)
        }
        else {
          $("#"+id+" .container-settings-flow-inputs").append(`
            <div class="container-flow-input">
              <label class="input-control checkbox small-check no-margin-top no-margin-bottom">
                <input type="checkbox">
                <span class="check"></span>
                <span class="caption">Select to delete</span>
              </label>
              <div class="grid no-margin-top no-margin-bottom">
                <div class="row cells2">
                  <div class="cell">
                    <div class="input-control select full-size no-margin-top no-margin-bottom">
                      <select class="${id}-select">
                        <option value="all">all</option>
                        <option value="esproposal.export_star_as">esproposal.export_star_as</option>
                        <option value="esproposal.export_star_as">esproposal.export_star_as</option>
                        <option value="esproposal.decorators">esproposal.decorators</option>
                        <option value="esproposal.class_instance_fields">esproposal.class_instance_fields</option>
                        <option value="esproposal.class_static_fields">esproposal.class_static_fields</option>
                        <option value="temp_dir">temp_dir</option>
                        <option value="suppress_comment">suppress_comment</option>
                        <option value="strip_root">strip_root</option>
                        <option value="traces">traces</option>
                        <option value="server.max_workers">server.max_workers</option>
                        <option value="munge_underscores">munge_underscores</option>
                        <option value="module.use_strict">module.use_strict</option>
                        <option value="module.file_ext">module.file_ext</option>
                        <option value="module.ignore_non_literal_requires">module.ignore_non_literal_requires</option>
                        <option value="module.system.node.resolve_dirname">module.system.node.resolve_dirname</option>
                        <option value="module.system">module.system</option>
                        <option value="module.name_mapper.extension">module.name_mapper.extension</option>
                        <option value="module.name_mapper">module.name_mapper</option>
                        <option value="log.file">log.file</option>
                      </select>
                    </div>
                  </div>
                  <div class="cell">
                    <div class="input-control text full-size no-margin-top no-margin-bottom" data-role="input">
                      <input type="text" class="${id}-input" value="" data-validate-func="required" data-validate-hint="This field can not be empty!" data-validate-hint-position="top" />
                      <button class="button helper-button clear" type="button"><span class="mif-cross"></span></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `)
        }
      })

      $(".flow-remove-button").click(function (event) {
        let id = $(this).attr("data-id-flow")
        let list_checked = $("#"+id+" .container-settings-flow-inputs .container-flow-input input:checked")
        for(let i = 0, length1 = list_checked.length; i < length1; i++){
          $(list_checked[i]).parents(".container-flow-input").remove()
        }
      })

    })

    ipcRenderer.on("load_config", (event, config) => {
      let project_details = config.settings.project_details
      $("#project_name").val(project_details.project_name)
      $("#project_path").val(config.settings.project_dir_name)
      $("#author").val(project_details.author)
      $("#author_uri").val(project_details.author_uri)
      $("#description").val(project_details.description)
      $("#version").val(project_details.version)
      $("#license").val(project_details.license)
      $("#license_uri").val(project_details.license_uri)
      $("#tags").val(project_details.tags)
      $("#type").val(project_details.type)
      type_change()
      project_type = project_details.type

      let project_settings = config.settings.project_settings
      $("#node_js_custom_path").val(project_settings.node_js_custom_path),
      $("#npm_custom_path").val(project_settings.npm_custom_path)
      $("#build_flow_source_folder").val(project_settings.build_flow.source_folder)
      $("#build_flow_destination_folder").val(project_settings.build_flow.destination_folder)
      utilWeb.set_options(".build_flow_options", project_settings.build_flow.options)

      for(let i = 0, length1 = project_type.length; i < length1; i++){
        let type = project_type[i]
        if ($("#"+type+"-tile").length > 0) {
          continue
        }
        if (fs.existsSync(__dirname+"/../../"+type+"/edit_project/index.html") && fs.existsSync(__dirname+"/../../"+type+"/edit_project/client.js") ){
          if (fs.existsSync(__dirname+"/../../"+type+"/edit_project/style.css") ){
            $("head").append(`<link rel="stylesheet" href="${__dirname+"/../../"+type+"/edit_project/style.css"}">`)
          }
          let client_js = require(__dirname+"/../../"+type+"/edit_project/client.js")
          let html = fs.readFileSync(__dirname+"/../../"+type+"/edit_project/index.html", "UTF-8")

          $(".tile-container").append(`
            <div id="${type}-tile" class="tile tile-wide ${ (client_js.tile_bg_color) ? client_js.tile_bg_color : '' } ${ (client_js.tile_fg_color) ? client_js.tile_fg_color : '' }" data-role="tile" onclick="metroDialog.open('#dialog-${type}-settings')">
              <div class="tile-content iconic">
                  ${ (client_js.icon) ? '<span class="icon"><img src="'+client_js.icon+'" alt=""></span>' : '<span class="icon mif-cogs"></span>' }
                  <span class="tile-label">${client_js.title}</span>
              </div>
              <div class="padding20" data-overlay="true" data-overlay-click-close="true" data-overlay-color="op-dark" data-role="dialog" id="dialog-${type}-settings" data-close-button="true">
                <form id="form-${type}-settings" action="#">
                  <div class="floating-action"> 
                    <button class="button primary rounded" type="submit"><span class="mif-floppy-disk"></span> save</button>
                  </div>
                </form>
              </div>
            </div>
          `)
          $("#dialog-"+type+"-settings form").prepend(html)
          client_js.prepareClientHtml({
            "ipcRenderer": ipcRenderer,
            "$": $,
            "utilWeb": utilWeb,
            "data_project": config,
            "fs": fs,
            "electron": require('electron')
          })
        }
      }

      $("#include-flow .container-flow-input, #ignore-flow .container-flow-input, #libs-flow .container-flow-input, #options-flow .container-flow-input").remove()
      let flow_settings = config.settings.flow_settings
      flow_settings.include.map(function (item, index) {
        $("#include-flow .flow-add-button").click()
        $($(".include-flow-input")[index]).val(item)
      })
      flow_settings.ignore.map(function (item, index) {
        $("#ignore-flow .flow-add-button").click()
        $($(".ignore-flow-input")[index]).val(item)
      })
      flow_settings.libs.map(function (item, index) {
        $("#libs-flow .flow-add-button").click()
        $($(".libs-flow-input")[index]).val(item)
      })
      flow_settings.options.map(function (item, index) {
        $("#options-flow .flow-add-button").click()
        $($(".options-flow-select")[index]).val(item[0])
        $($(".options-flow-input")[index]).val(item[1])
      })
      if(flow_settings.flow_checker_enabled){
        $('#flow_checker_enabled').attr('checked', 'checked')
      }
    })

    ipcRenderer.on("error", (event, msg) => {
      $.Notify({
        caption: 'Error',
        content: msg,
        type: 'alert'
      });
    })

    ipcRenderer.on("success", (event, msg) => {
      $.Notify({
        caption: 'Success',
        content: msg,
        type: 'success'
      });
    })
    
    ipcRenderer.on("delete-item-menu", (event, type) => {
      $("#dialog-"+type+"-settings").remove()
      $("#"+type+"-tile").remove()
    })
  </script>
</body>
</html>